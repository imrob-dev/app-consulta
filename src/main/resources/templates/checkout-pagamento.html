<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento PIX - Painel de Consultas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: #f8fafc;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
        }

        .payment-header {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            color: white;
            padding: 2rem 0;
        }

        .payment-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2rem;
        }

        .qr-code-container {
            background: #f8fafc;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
        }

        .qr-code-container img {
            max-width: 250px;
            border-radius: 0.5rem;
        }

        .pix-code {
            background: #f1f5f9;
            border-radius: 0.5rem;
            padding: 1rem;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .btn-copy {
            background: #4f46e5;
            border: none;
        }

        .btn-copy:hover {
            background: #4338ca;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .timer {
            font-size: 2rem;
            font-weight: 700;
            color: #4f46e5;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="payment-header">
        <div class="container">
            <h1 class="h3 mb-0">
                <i class="bi bi-qr-code me-2"></i>Pagamento via PIX
            </h1>
        </div>
    </header>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="payment-card">
                    <div class="text-center mb-4">
                        <span class="status-badge status-pending" id="statusBadge">
                            <i class="bi bi-clock me-1"></i>Aguardando Pagamento
                        </span>
                    </div>

                    <div class="row g-4">
                        <!-- QR Code -->
                        <div class="col-md-6">
                            <div class="qr-code-container">
                                <h5 class="mb-3">Escaneie o QR Code</h5>
                                <img th:src="'data:image/png;base64,' + ${checkout.qrCodeBase64}"
                                     alt="QR Code PIX" class="mb-3">
                                <p class="text-muted small mb-0">
                                    Abra o app do seu banco e escaneie o código
                                </p>
                            </div>
                        </div>

                        <!-- Código Copia e Cola -->
                        <div class="col-md-6">
                            <h5 class="mb-3">Ou copie o código PIX</h5>
                            <div class="pix-code mb-3" id="pixCode" th:text="${checkout.codigoPix}">
                                Código PIX aqui...
                            </div>
                            <button class="btn btn-copy btn-primary w-100" onclick="copyPixCode()">
                                <i class="bi bi-clipboard me-2"></i>Copiar Código
                            </button>

                            <hr class="my-4">

                            <h5 class="mb-3">Defina sua senha</h5>
                            <form th:action="@{/checkout/confirmar/{id}(id=${checkout.pagamentoId})}" method="post" id="confirmForm">
                                <div class="mb-3">
                                    <label class="form-label">Senha de acesso</label>
                                    <input type="password" class="form-control" name="senha"
                                           placeholder="Mínimo 6 caracteres" minlength="6" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirmar senha</label>
                                    <input type="password" class="form-control" id="confirmSenha"
                                           placeholder="Repita a senha" required>
                                </div>
                                <button type="submit" class="btn btn-success w-100" id="confirmBtn">
                                    <i class="bi bi-check-circle me-2"></i>Confirmar Pagamento (Simulado)
                                </button>
                            </form>

                            <div class="alert alert-info mt-3 small">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Modo de teste:</strong> Clique em "Confirmar Pagamento" para simular
                                a confirmação do pagamento PIX.
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4 pt-4 border-top">
                        <p class="text-muted mb-2">O pagamento expira em:</p>
                        <div class="timer" id="timer">30:00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const pagamentoId = /*[[${checkout.pagamentoId}]]*/ 0;
        let timeLeft = 30 * 60; // 30 minutos em segundos

        function copyPixCode() {
            const code = document.getElementById('pixCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('.btn-copy');
                btn.innerHTML = '<i class="bi bi-check me-2"></i>Copiado!';
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-clipboard me-2"></i>Copiar Código';
                }, 2000);
            });
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft > 0) {
                timeLeft--;
                setTimeout(updateTimer, 1000);
            }
        }

        function checkPaymentStatus() {
            fetch(`/api/v1/checkout/status/${pagamentoId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'CONFIRMADO') {
                        window.location.href = '/checkout/sucesso';
                    }
                });
        }

        // Validar senhas iguais
        document.getElementById('confirmForm').addEventListener('submit', function(e) {
            const senha = document.querySelector('input[name="senha"]').value;
            const confirmSenha = document.getElementById('confirmSenha').value;

            if (senha !== confirmSenha) {
                e.preventDefault();
                alert('As senhas não conferem!');
            }
        });

        // Iniciar timer
        updateTimer();

        // Verificar status a cada 5 segundos
        setInterval(checkPaymentStatus, 5000);
    </script>
</body>
</html>
